
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>js/css build optimize flow - Practice makes perfect</title>
	<meta name="author" content="Weichien Hung">

	
	<meta name="description" content="I changed the my work frontend module build optimize flow few day ago.
The original build flow is use wro4j plugin and my buildhelper. The cons is &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Practice makes perfect" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><a class="myheader-avatar" href="/"><img src="/images/samuel.jpg"></a>
<div class="myheader-slogan">
<h1><a href="/">Practice makes perfect</a></h1>
<h2>...</h2>
</div>
<nav id="main-nav"><ul class="main">
	<!-- <li><a href="/">Blog</a></li> -->
	<li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories">Tags</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a id="menu-btn" class="button">Menu</a>
		<div class="container"><ul class="main">
	<!-- <li><a href="/">Blog</a></li> -->
	<li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories">Tags</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:weichienhung.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		<a class="facebook" href="http://www.facebook.com/weichien.hung" title="Facebook">Facebook</a>
		
		
		<a class="google" href="https://plus.google.com/113676445086645352045?rel=author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/HungWeichien" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/weichienhung" title="GitHub">GitHub</a>
		
    
		
		
		
		
		<!-- 
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		 -->
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:weichienhung.github.io">
	</form>
</nav>

</header>
<!-- 	
		
	 -->
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Js/css Build Optimize Flow</h2>
	<div class="entry-content"><p>I changed the my work frontend module build optimize flow few day ago.
The original build flow is use <a href="https://code.google.com/p/wro4j/wiki/MavenPlugin">wro4j plugin</a> and my buildhelper. The cons is that there&#8217;re many trivial steps when adding a new page.
I decide to update it with new way. I study the <a href="http://yeoman.io">YEOMAN</a> build flow and apply it in my module. The result is good.</p>

<p>YEOMAN uses nodejs and <a href="http://gruntjs.com">Grunt</a> to do optimize.
But the company module system is using Maven. The first step is to find a maven plugin to run grunt. I choose <a href="https://github.com/allegro/grunt-maven-plugin">grunt-maven-plugin</a> and it&#8217;s easy to integrate.</p>

<!-- more -->


<p>See my snippet code from pom.xml. I copy all files from <code>src/main/webapp</code> to <code>${project.build.directory}/original</code> and run grunt in prepare package phase. I don&#8217;t want to let grunt access <code>src/main/webapp</code> so the <code>${project.build.directory}/original</code> will be my grunt project source folder.</p>

<figure class='code'><figcaption><span>pom.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>  <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;artifactId&gt;</span>maven-resources-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;version&gt;</span>2.6<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>  <span class="nt">&lt;executions&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- copy webapp to target folder --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>copy-webapp<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;phase&gt;</span>process-resources<span class="nt">&lt;/phase&gt;</span>
</span><span class='line'>      <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>        <span class="nt">&lt;goal&gt;</span>copy-resources<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>      <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;outputDirectory&gt;</span>${project.build.directory}/original<span class="nt">&lt;/outputDirectory&gt;</span>
</span><span class='line'>        <span class="nt">&lt;resources&gt;</span>
</span><span class='line'>          <span class="nt">&lt;resource&gt;</span>
</span><span class='line'>            <span class="nt">&lt;directory&gt;</span>src/main/webapp/<span class="nt">&lt;/directory&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/resource&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/resources&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/executions&gt;</span>
</span><span class='line'><span class="nt">&lt;/plugin&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;plugin&gt;</span>
</span><span class='line'>  <span class="nt">&lt;groupId&gt;</span>pl.allegro<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;artifactId&gt;</span>grunt-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>  <span class="nt">&lt;version&gt;</span>1.2.1<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>  <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>    <span class="nt">&lt;showColors&gt;</span>true<span class="nt">&lt;/showColors&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>  <span class="nt">&lt;executions&gt;</span>
</span><span class='line'>    <span class="nt">&lt;execution&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>grunt-build<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;phase&gt;</span>prepare-package<span class="nt">&lt;/phase&gt;</span>
</span><span class='line'>      <span class="nt">&lt;goals&gt;</span>
</span><span class='line'>        <span class="nt">&lt;goal&gt;</span>npm<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>        <span class="nt">&lt;goal&gt;</span>grunt<span class="nt">&lt;/goal&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/goals&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/execution&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/executions&gt;</span>
</span><span class='line'><span class="nt">&lt;/plugin&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here i will skip the installation of yeoman. Let&#8217;s see how yeoman build flow work.
I set the <code>gamenow.app</code> to <code>target/original</code> that is the folder copy from <code>src/main/webapp</code>. <code>gamenow.dist</code> will be <code>target/storefront</code> and this folder will be packaged to WAR file in maven build.</p>

<figure class='code'><figcaption><span>Gruntfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">grunt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Load grunt tasks automatically</span>
</span><span class='line'>  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;load-grunt-tasks&#39;</span><span class="p">)(</span><span class="nx">grunt</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Time how long tasks take. Can help when optimizing build times</span>
</span><span class='line'>  <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;time-grunt&#39;</span><span class="p">)(</span><span class="nx">grunt</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">gamenow</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Configurable paths</span>
</span><span class='line'>      <span class="nx">app</span><span class="o">:</span> <span class="s1">&#39;target/original&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">dist</span><span class="o">:</span> <span class="s1">&#39;target/storefront&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">....</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>YEOMAN uses usemin grunt plugin to create concat,minify,rewrite. In <code>useminPrepare</code> setting i set the html sources in <code>&lt;%= gamenow.app %&gt;/*.html</code>. It means usemin plugin will search all .html files and find the build block description to create configuration automatically. You will see how to set build block description in html later. The <code>flow.steps</code> enables us to add/modify step ourselves. Here i add a new step <code>copy</code> and it only executes <code>concat</code>. The <code>js</code> and <code>css</code> steps are default.<br/>
In <code>usemin</code> setting i add a <code>copy</code> function definition in <code>blockReplacements</code>. The function is quite simple. We need to set html and css folders too because usemin plugin needs to find files to modify in these folders.</p>

<figure class='code'><figcaption><span>Gruntfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">useminPrepare</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">dest</span><span class="o">:</span> <span class="s1">&#39;&lt;%= gamenow.dist %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">flow</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">steps</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">js</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span><span class="s1">&#39;uglifyjs&#39;</span><span class="p">],</span>
</span><span class='line'>          <span class="nx">css</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span><span class="s1">&#39;cssmin&#39;</span><span class="p">],</span>
</span><span class='line'>          <span class="nx">copy</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;concat&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nx">post</span><span class="o">:</span> <span class="p">{}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">html</span><span class="o">:</span> <span class="s1">&#39;&lt;%= gamenow.app %&gt;/*.html&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">usemin</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">assetsDirs</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;&lt;%= gamenow.dist %&gt;&#39;</span><span class="p">],</span>
</span><span class='line'>      <span class="nx">blockReplacements</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">copy</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="s1">&#39;&lt;script src=&quot;&#39;</span> <span class="o">+</span> <span class="nx">block</span><span class="p">.</span><span class="nx">dest</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&lt;/script&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">html</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;&lt;%= gamenow.dist %&gt;/*.html&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s take a look at sample.html. Use <code>&lt;!-- build:step path --&gt;</code> to wrap your css. Here the step is <code>css</code> and path is <code>css/all.css</code>. The usemin plugin will use <code>concat</code> to merge all css files to <code>css/all.css</code> and <code>cssmin</code> plugin to minify it.<br/>
Use <code>&lt;!-- build:js path --&gt;</code> to optimize your JS. The <code>js</code> step will do <code>concat</code> and <code>ugilfy</code> in defult.
Use <code>&lt;!-- build:copy --&gt;</code> to only concat file without ugilfy. Because i want config file could be modified manually. Obfuscated file makes hard to modify.</p>

<figure class='code'><figcaption><span>sample.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="c">&lt;!-- build:css css/all.css --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/basics/normalize.css&quot;</span>  <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/desktop/1.css&quot;</span>  <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/desktop/2.css&quot;</span>  <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- endbuild --&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c">&lt;!-- build:js js/build/vendor.js --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/vendor/jquery-1.9.1.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/vendor/jquery.scrollTo-1.4.3.1.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/vendor/handlebars-v1.3.0.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- endbuild --&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c">&lt;!-- build:copy js/config.js --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/settings/config.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- endbuild --&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to overwrite the default <code>cssmin</code> and <code>concat</code> settings you could just add the block in config. I overwrite the original concat process function. Because the css url path will be wrong if your source css and merged css are in different folder. See my comment inside function.</p>

<figure class='code'><figcaption><span>Gruntfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">cssmin</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">noAdvanced</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">concat</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">separator</span><span class="o">:</span> <span class="s1">&#39;\n&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">process</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">filepath</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">cssPatt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;(\/.*\/).*\.css$&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">cssPatt</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">filepath</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// rewrite the url in css file.</span>
</span><span class='line'>          <span class="c1">// url(../../img/bluebg.jpg) -&gt; url(../img/bluebg.jpg)</span>
</span><span class='line'>          <span class="c1">// url(../../../img/bluebg2.jpg) -&gt; url(../img/bluebg.2jpg)</span>
</span><span class='line'>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">urlPatt</span> <span class="o">=</span> <span class="sr">/url\((\.\.\/){1,}(.*)\)/g</span><span class="p">;</span>
</span><span class='line'>          <span class="k">return</span> <span class="nx">src</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">urlPatt</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">replacedUrl</span> <span class="o">=</span> <span class="s1">&#39;url(../&#39;</span> <span class="o">+</span> <span class="nx">p2</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">replacedUrl</span><span class="p">;</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nx">src</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To prevent browser cache the js/css files need to change file name when the content are different. We use <code>rev</code> plugin to add <code>md5</code> in file name. Don&#8217;t worry about the filename changed because <code>usemin</code> is smart enough to search files in <code>assetsDirs: ['&lt;%= gamenow.dist %&gt;']</code>.</p>

<figure class='code'><figcaption><span>Gruntfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">rev</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">dist</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">files</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">src</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="s1">&#39;&lt;%= gamenow.dist %&gt;/js/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;&lt;%= gamenow.dist %&gt;/js/build/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;&lt;%= gamenow.dist %&gt;/css/*.css&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>In my module i also want to keep the originl .html file for debug. I add a task <code>debugHtml</code> to get it. I copy .html files to dist folder with <code>-dev</code> filename. Task <code>nonOptimizeFiles</code> is to copy the rest files.</p>

<figure class='code'><figcaption><span>Gruntfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">copy</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">filesNeedRewrite</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">files</span><span class="o">:</span> <span class="p">[{</span>
</span><span class='line'>        <span class="nx">expand</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">dot</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cwd</span><span class="o">:</span> <span class="s1">&#39;&lt;%= gamenow.app %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">dest</span><span class="o">:</span> <span class="s1">&#39;&lt;%= gamenow.dist %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">src</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;*.html&#39;</span><span class="p">]</span>
</span><span class='line'>      <span class="p">}]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">debugHtml</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">files</span><span class="o">:</span> <span class="p">[{</span>
</span><span class='line'>        <span class="nx">expand</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">src</span><span class="o">:</span> <span class="s1">&#39;&lt;%= gamenow.app %&gt;/*.html&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">dest</span><span class="o">:</span> <span class="s1">&#39;&lt;%= gamenow.dist %&gt;/&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">rename</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="p">,</span> <span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">//rename *.html to *-dev.html</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">extname</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">src</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="nx">dest</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s2">&quot;-dev&quot;</span> <span class="o">+</span> <span class="nx">extname</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">nonOptimizeFiles</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">files</span><span class="o">:</span> <span class="p">[{</span>
</span><span class='line'>        <span class="nx">expand</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">dot</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">cwd</span><span class="o">:</span> <span class="s1">&#39;&lt;%= gamenow.app %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">dest</span><span class="o">:</span> <span class="s1">&#39;&lt;%= gamenow.dist %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">src</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="s1">&#39;*.{ico,png,xml,jsp,json}&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;.htaccess&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;WEB-INF/**&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;img/**&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//copy original js,css files for debug</span>
</span><span class='line'>          <span class="s1">&#39;js/*/**&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;css/*/**&#39;</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>      <span class="p">}]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The final optimized sample.html would be like</p>

<figure class='code'><figcaption><span>sample.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/46d81h87.all.css&quot;</span>  <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/build/xh64yr8d.vendor.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/2sd4fgcv.config.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The grunt build task sequence.</p>

<figure class='code'><figcaption><span>sample.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  grunt.registerTask(&#39;build&#39;, [
</span><span class='line'>    &#39;useminPrepare&#39;,
</span><span class='line'>    &#39;concat&#39;,
</span><span class='line'>    &#39;cssmin&#39;,
</span><span class='line'>    &#39;uglify&#39;,
</span><span class='line'>    &#39;copy:filesNeedRewrite&#39;,
</span><span class='line'>    &#39;rev&#39;,
</span><span class='line'>    &#39;usemin&#39;,
</span><span class='line'>    &#39;copy:debugHtml&#39;,
</span><span class='line'>    &#39;copy:nonOptimizeFiles&#39;
</span><span class='line'>  ]);
</span></code></pre></td></tr></table></div></figure>


<p>My package.json</p>

<figure class='code'><figcaption><span>package.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ugamenow&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;grunt&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.4.1&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;load-grunt-tasks&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.2.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;time-grunt&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.2.0&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-clean&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.5.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-concat&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.3.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-cssmin&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.10.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-copy&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.5.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-contrib-uglify&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.2.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-rev&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.1.0&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;grunt-usemin&quot;</span><span class="p">:</span> <span class="s2">&quot;~2.3.0&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-02T09:58:00+08:00" pubdate data-updated="true">Aug 2<span>nd</span>, 2014</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
	
	<div class="comments"><a href="#disqus_thread">Comments</a></div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Weichien Hung

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $(document).ready(function(){
    $('.fancybox').fancybox();
  })
})(jQuery);
</script> 


<script type="text/javascript">
      var disqus_shortname = 'weichienhung';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://weichienhung.github.io/blog/2014/08/02/js-slash-css-build-optimize-flow/';
        var disqus_url = 'http://weichienhung.github.io/blog/2014/08/02/js-slash-css-build-optimize-flow/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>